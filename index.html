<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Casino Lamia ‚Äî First Bola (Simple)</title>
<style>
  :root{--bg:#0f1115;--panel:#ffffff;--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--pill:#f8fafc;--dash:#cbd5e1;--accent:#2563eb;--ok:#22c55e;--danger:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#eaeef2;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  .wrap{max-width:860px;margin:0 auto;padding:16px}
  .top{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#7c3aed,#22c55e);display:grid;place-items:center}
  .title{font-weight:800;font-size:18px}
  .card{background:var(--panel);color:var(--ink);border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type=text]{flex:1;min-width:180px;padding:12px;border-radius:10px;border:1px solid var(--line)}
  button{border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
  .ghost{background:transparent;border:1px solid #cbd5e1}
  .primary{background:var(--accent);color:#fff}
  .danger{background:var(--danger);color:#fff}
  .grid{display:grid;gap:12px}
  @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  .section{background:#f1f5f9;border:1px solid var(--line);border-radius:14px;padding:12px}
  .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .name{font-weight:800}
  .counter{color:var(--muted);font-weight:700}
  .pillbar{display:flex;gap:8px;flex-wrap:wrap}
  .pill{background:var(--pill);border:1px solid #d1d5db;border-radius:10px;padding:10px 12px;font-weight:700}
  .pill.open{border-style:dashed;border-color:var(--dash);color:#64748b}
  .tiny{font-size:12px;color:#94a3b8}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="logo">üé≤</div>
    <div class="title">Casino Lamia</div>
  </div>

  <!-- name + actions -->
  <div class="card">
    <div class="row">
      <input id="playerName" type="text" placeholder="Your name (e.g. Shehab)" />
      <button id="saveName" class="primary">Save Name</button>
      <button id="clearMine" class="ghost" title="Remove yourself from any spot">I‚Äôm Out</button>
      <button id="resetBoard" class="danger" title="Clear all spots">Reset Board</button>
    </div>
    <div class="tiny" style="margin-top:6px">Tip: Save your name once, then tap any ‚ÄúOpen‚Äù spot to claim it. Tap your own name to free it.</div>
  </div>

  <!-- board -->
  <div class="card">
    <div class="grid">
      <div class="section">
        <div class="head"><div class="name">First Bola</div><div class="counter" id="c_first">0/4</div></div>
        <div class="pillbar" id="p_first"></div>
      </div>
      <div class="section">
        <div class="head"><div class="name">Next</div><div class="counter" id="c_next">0/2</div></div>
        <div class="pillbar" id="p_next"></div>
      </div>
      <div class="section">
        <div class="head"><div class="name">After Next</div><div class="counter" id="c_after_next">0/2</div></div>
        <div class="pillbar" id="p_after_next"></div>
      </div>
      <div class="section">
        <div class="head"><div class="name">After After</div><div class="counter" id="c_after_after">0/2</div></div>
        <div class="pillbar" id="p_after_after"></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  /* Your Firebase config */
  const firebaseConfig = {
    apiKey: "AIzaSyCo_oLqNL2kElNbyT4GQuJ5IU8XbV8UgiY",
    authDomain: "casino-lamia-58222.firebaseapp.com",
    projectId: "casino-lamia-58222",
    storageBucket: "casino-lamia-58222.firebasestorage.app",
    messagingSenderId: "857378701223",
    appId: "1:857378701223:web:63b245e290a80a3e818082",
    measurementId: "G-0BXHB0R5EJ"
  };

  /* Firebase CDN ESM */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth, signInAnonymously, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot, runTransaction
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /* Board document (single shared board) */
  const boardRef = doc(db, "boards", "main");

  /* UI refs */
  const elName = document.getElementById("playerName");
  const saveNameBtn = document.getElementById("saveName");
  const clearMineBtn = document.getElementById("clearMine");
  const resetBtn = document.getElementById("resetBoard");

  const c_first = document.getElementById("c_first");
  const c_next = document.getElementById("c_next");
  const c_an = document.getElementById("c_after_next");
  const c_aa = document.getElementById("c_after_after");
  const p_first = document.getElementById("p_first");
  const p_next = document.getElementById("p_next");
  const p_an = document.getElementById("p_after_next");
  const p_aa = document.getElementById("p_after_after");

  /* Local name (stored only on device) */
  const getMyName = () => localStorage.getItem("cl_name") || "";
  const setMyName = (v) => localStorage.setItem("cl_name", v.trim());

  elName.value = getMyName();

  saveNameBtn.onclick = () => {
    const v = elName.value.trim();
    if (!v) return alert("Type a name first.");
    setMyName(v);
    alert("Saved.");
  };

  /* Start anonymous auth */
  onAuthStateChanged(auth, async (u) => {
    if (!u) await signInAnonymously(auth);
    // ensure board exists
    const snap = await getDoc(boardRef);
    if (!snap.exists()) {
      await setDoc(boardRef, {
        first_bola: ["", "", "", ""], // 4 slots
        next: ["", ""],               // 2
        after_next: ["", ""],         // 2
        after_after: ["", ""],        // 2
        updatedAt: Date.now()
      });
    }
  });

  /* Live board */
  onSnapshot(boardRef, (snap) => {
    const d = snap.data() || {};
    drawRow(p_first, d.first_bola || ["", "", "", ""], 4, "first_bola");
    drawRow(p_next,  d.next || ["",""], 2, "next");
    drawRow(p_an,    d.after_next || ["",""], 2, "after_next");
    drawRow(p_aa,    d.after_after || ["",""], 2, "after_after");

    c_first.textContent = `${countFilled(d.first_bola||[])} / 4`;
    c_next.textContent  = `${countFilled(d.next||[])} / 2`;
    c_an.textContent    = `${countFilled(d.after_next||[])} / 2`;
    c_aa.textContent    = `${countFilled(d.after_after||[])} / 2`;
  });

  function countFilled(arr){ return arr.filter(x=>x && x.trim().length>0).length; }

  function drawRow(container, arr, cap, key){
    container.innerHTML = "";
    for (let i=0;i<cap;i++){
      const name = (arr[i]||"").trim();
      const btn = document.createElement("button");
      btn.className = "pill" + (name ? "" : " open");
      btn.textContent = name || "Open";
      btn.onclick = () => toggleSpot(key, i);
      container.appendChild(btn);
    }
  }

  async function toggleSpot(bucket, idx){
    const my = getMyName();
    if(!my) return alert("Save your name first.");

    await runTransaction(db, async (tx) => {
      const snap = await tx.get(boardRef);
      const d = snap.data();

      const buckets = ["first_bola","next","after_next","after_after"];
      // If my name is already anywhere and I'm tapping an empty, block
      const alreadyAt = buckets.find(b => (d[b]||[]).some(x => x && x.trim() === my));
      const slotName = (d[bucket][idx]||"").trim();

      if (slotName === my) {
        // free my slot
        const arr = [...d[bucket]];
        arr[idx] = "";
        tx.update(boardRef, { [bucket]: arr, updatedAt: Date.now() });
        return;
      }

      if (slotName) {
        // occupied by someone else
        throw new Error("This spot is already taken.");
      }

      if (alreadyAt && alreadyAt !== bucket) {
        throw new Error("You already claimed a spot. Tap your name to free it first.");
      }

      // place me here
      const arr = [...d[bucket]];
      arr[idx] = my;
      tx.update(boardRef, { [bucket]: arr, updatedAt: Date.now() });
    }).catch(e => alert(e.message));
  }

  clearMineBtn.onclick = async ()=>{
    const my = getMyName();
    if(!my) return alert("Save your name first.");
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(boardRef);
      const d = snap.data();
      const buckets = ["first_bola","next","after_next","after_after"];
      const updates = {};
      let changed = false;
      for (const b of buckets){
        const arr = [...d[b]];
        for (let i=0;i<arr.length;i++){
          if ((arr[i]||"").trim() === my){ arr[i] = ""; changed = true; }
        }
        updates[b] = arr;
      }
      if (changed) tx.update(boardRef, {...updates, updatedAt: Date.now()});
    });
  };

  // Simple reset with a prompt PIN (default 7777). Change this PIN if you like.
  const RESET_PIN = "7777";
  resetBtn.onclick = async ()=>{
    const pin = prompt("Reset PIN?");
    if (pin !== RESET_PIN) return alert("Wrong PIN.");
    await setDoc(boardRef, {
      first_bola: ["","","",""],
      next: ["",""],
      after_next: ["",""],
      after_after: ["",""],
      updatedAt: Date.now()
    });
  };
</script>
</body>
</html>
